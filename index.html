<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - ÙƒØ§ÙØªÙŠØ±ÙŠØ§</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }

    .container { background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); padding: 40px; width: 100%; max-width: 450px; position: relative; }

    .logo { text-align: center; margin-bottom: 30px; }
    .logo i { font-size: 50px; color: #667eea; margin-bottom: 15px; }
    h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 28px; }
    .subtitle { color: #666; text-align: center; margin-bottom: 30px; }

    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
    input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
    input:focus { outline: none; border-color: #667eea; }

    .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
    .btn:hover { transform: translateY(-2px); }

    .links { text-align: center; margin-top: 20px; }
    .links a { color: #667eea; text-decoration: none; }

    .message { padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center; display: none; }
    .success { background: #d4edda; color: #155724; display: block; }
    .error { background: #f8d7da; color: #721c24; display: block; }

    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    #splash { position: absolute; top:0; left:0; width:100%; height:100%; background: #667eea; color: white; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 20px; text-align: center; transition: opacity 0.5s; z-index: 999; }
</style>
</head>
<body>
<div class="container">
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="splash">
        <div>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</div>
        <div id="lastLoginDisplay" style="margin-top:10px; font-size:16px;"></div>
    </div>

    <div class="logo">
        <i>ğŸ”</i>
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p class="subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ</p>
    </div>

    <form id="loginForm">
        <div class="form-group">
            <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" id="email" placeholder="Ø§Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
        </div>

        <div class="form-group">
            <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
        </div>

        <button type="button" class="btn" onclick="loginUser()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

        <div id="message" class="message"></div>

        <div class="links">
            <p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="register.html">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a></p>
        </div>
    </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import { getDatabase, ref, update, get, child } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyC3-Ljb1uKSD4VhgavLUmwebqVivLxFIis",
    authDomain: "cafeteria-app-82268.firebaseapp.com",
    databaseURL: "https://cafeteria-app-82268-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cafeteria-app-82268",
    storageBucket: "cafeteria-app-82268.appspot.com",
    messagingSenderId: "457381739769",
    appId: "1:457381739769:web:409cb927ef54368cb3f628"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

const splash = document.getElementById('splash');
const lastLoginDisplay = document.getElementById('lastLoginDisplay');

function showMessage(message, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = 'message ' + type;
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
window.loginUser = async function () {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!email || !password) {
        showMessage('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
    }

    showMessage('â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', 'success');

    try {
        await setPersistence(auth, browserLocalPersistence);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const now = new Date().toISOString();
        await update(ref(database, 'users/' + user.uid), { lastLogin: now });

        showMessage('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ÙŠÙˆ', 'success');

    } catch (error) {
        let errorMessage = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        switch (error.code) {
            case 'auth/user-not-found':
                errorMessage = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯';
                break;
            case 'auth/wrong-password':
                errorMessage = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                break;
            case 'auth/invalid-email':
                errorMessage = 'âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
                break;
            default:
                errorMessage = 'âŒ ' + error.message;
        }
        showMessage(errorMessage, 'error');
    }
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡)
onAuthStateChanged(auth, async (user) => {
    if (user) {
        const dbRef = ref(database);
        const snapshot = await get(child(dbRef, 'users/' + user.uid + '/lastLogin'));
        const lastLogin = snapshot.exists() ? snapshot.val() : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¨Ù‚';
        lastLoginDisplay.textContent = 'Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: ' + lastLogin;
        splash.style.opacity = '0';
        setTimeout(() => { splash.style.display = 'none'; }, 500);
    } else {
        splash.style.display = 'none';
    }
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('password').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') loginUser();
});
</script>
</body>
</html>
