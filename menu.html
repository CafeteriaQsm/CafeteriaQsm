<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>قائمة الطعام</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary-color: #c62828;
  --primary-light: #ff5f52;
  --primary-dark: #8e0000;
  --secondary-color: #ffb74d;
  --accent-color: #ff9800;
  --light-bg: #fff8f0;
  --card-bg: #ffffff;
  --text-dark: #3e2723;
  --text-light: #5d4037;
  --shadow: 0 4px 12px rgba(198, 40, 40, 0.15);
  --transition: all 0.3s ease;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction:rtl; text-align:right; background-color:var(--light-bg); color:var(--text-dark); line-height:1.6; }

header { background:linear-gradient(135deg,var(--primary-color),var(--primary-dark)); color:white; padding:20px 0; box-shadow:0 4px 12px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100; }
.header-content { max-width:1200px; margin:0 auto; padding:0 20px; display:flex; justify-content:space-between; align-items:center; }
.logo { display:flex; align-items:center; gap:10px; font-size:1.5rem; font-weight:bold; }
.logo i { font-size:2rem; }
.header-buttons { display:flex; align-items:center; gap:15px; }
.cart-link, .login-btn, .logout-btn { background-color:white; color:var(--primary-color); padding:10px 20px; border-radius:50px; text-decoration:none; font-weight:bold; display:flex; align-items:center; gap:8px; transition:var(--transition); box-shadow:var(--shadow); border:none; cursor:pointer; font-size:0.9rem; }
.cart-link:hover, .login-btn:hover, .logout-btn:hover { background-color:var(--secondary-color); transform:translateY(-2px); }
.user-info { color:white; display:flex; align-items:center; gap:10px; font-size:0.9rem; }
.user-info i { font-size:1.2rem; }

.categories { display:flex; overflow-x:auto; padding:15px 10px; gap:10px; background-color:white; box-shadow:0 2px 8px rgba(0,0,0,0.05); position:sticky; top:80px; z-index:90; }
.category-btn { background-color:white; border:2px solid var(--primary-color); color:var(--primary-color); padding:8px 16px; border-radius:50px; white-space:nowrap; cursor:pointer; transition:var(--transition); font-weight:600; }
.category-btn.active, .category-btn:hover { background-color:var(--primary-color); color:white; }

.container { max-width:1200px; margin:0 auto; padding:20px; }
.section-title { color:var(--primary-color); margin:30px 0 20px; padding-bottom:10px; border-bottom:2px dashed var(--secondary-color); font-size:1.8rem; }
.menu-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:25px; margin-bottom:40px; }
.meal-card { background-color:var(--card-bg); border-radius:16px; overflow:hidden; box-shadow:var(--shadow); transition:var(--transition); position:relative; }
.meal-card:hover { transform:translateY(-8px); box-shadow:0 12px 20px rgba(198,40,40,0.2); }
.meal-card img { width:100%; height:180px; object-fit:cover; transition:var(--transition); }
.meal-card:hover img { transform:scale(1.05); }
.meal-content { padding:15px; }
.meal-card h3 { color:var(--text-dark); margin-bottom:8px; font-size:1.3rem; }
.meal-card p, .meal-card span { color:var(--text-light); margin-bottom:15px; }
.price { color:var(--primary-color); font-weight:bold; font-size:1.2rem; display:block; margin-bottom:15px; }
.meal-card button { background:linear-gradient(to right,var(--primary-color),var(--primary-light)); color:white; border:none; padding:10px 20px; border-radius:50px; cursor:pointer; width:100%; font-weight:bold; font-size:1rem; transition:var(--transition); display:flex; justify-content:center; align-items:center; gap:8px; }
.meal-card button:hover { background:linear-gradient(to right,var(--primary-dark),var(--primary-color)); transform:translateY(-2px); }
.badge { position:absolute; top:15px; left:15px; background-color:var(--secondary-color); color:var(--text-dark); padding:5px 10px; border-radius:50px; font-size:0.8rem; font-weight:bold; }

.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); backdrop-filter:blur(5px); }
.modal-content { background-color:var(--card-bg); margin:5% auto; padding:25px; border-radius:16px; width:90%; max-width:500px; text-align:right; box-shadow:0 10px 30px rgba(0,0,0,0.2); animation:modalFade 0.3s; }
@keyframes modalFade { from { opacity:0; transform:translateY(-30px); } to { opacity:1; transform:translateY(0); } }
.modal h3 { color:var(--primary-color); margin-bottom:15px; font-size:1.5rem; text-align:center; padding-bottom:10px; border-bottom:2px dashed var(--secondary-color); }
.extras-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; margin-top:10px; }
.extras-grid label { display:flex; align-items:center; gap:8px; padding:8px 12px; background-color:#f5f5f5; border-radius:8px; cursor:pointer; transition:var(--transition); }
.extras-grid label:hover { background-color:#eeeeee; }
.extras-grid input[type="checkbox"] { width:18px; height:18px; accent-color:var(--primary-color); }
.modal-buttons { display:flex; justify-content:space-between; margin-top:20px; gap:10px; }
.modal button { padding:12px 24px; border:none; border-radius:50px; font-size:1rem; cursor:pointer; transition:var(--transition); flex:1; display:flex; justify-content:center; align-items:center; gap:8px; }
.add-btn { background:linear-gradient(to right,var(--primary-color),var(--primary-light)); color:white; font-weight:bold; }
.add-btn:hover { background:linear-gradient(to right,var(--primary-dark),var(--primary-color)); transform:translateY(-2px); }
.close-btn { background-color:#e0e0e0; color:var(--text-dark); }
.close-btn:hover { background-color:#d6d6d6; }

@media(max-width:768px){ 
  .header-content{flex-direction:column; gap:15px;} 
  .categories{top:130px;} 
  .menu-container{grid-template-columns:repeat(auto-fill,minmax(250px,1fr));} 
  .section-title{font-size:1.5rem;} 
  .header-buttons { flex-wrap: wrap; justify-content: center; }
}
@media(max-width:480px){ 
  .menu-container{grid-template-columns:1fr;} 
  .modal-content{width:95%; padding:20px;} 
  .extras-grid{grid-template-columns:1fr;} 
  .user-info { flex-direction: column; gap: 5px; }
  .user-info span { font-size: 0.8rem; }
}
</style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="logo"><i class="fas fa-utensils"></i><span>مطعمنا الشهي</span></div>
    <div class="header-buttons">
      <a href="cart.html" class="cart-link"><i class="fas fa-shopping-cart"></i> <span>السلة</span></a>
      <div id="userSection">
        <!-- سيتم تعبئته بالجافاسكريبت -->
      </div>
    </div>
  </div>
</header>

<div class="categories">
  <button class="category-btn active" data-category="all">الكل</button>
  <button class="category-btn" data-category="main">وجبات رئيسية</button>
  <button class="category-btn" data-category="italian">مأكولات ايطالية</button>
  <button class="category-btn" data-category="home">اكل بيتي</button>
  <button class="category-btn" data-category="salads">سلطات</button>
  <button class="category-btn" data-category="sandwiches">ساندويتشات</button>
  <button class="category-btn" data-category="pastries">معجنات</button>
  <button class="category-btn" data-category="drinks">مشروبات</button>
  <button class="category-btn" data-category="extras">اضافات</button>
</div>

<div class="container">
  <h2 class="section-title">الوجبات الرئيسية</h2>
  <div class="menu-container" id="mainDishes"></div>
  <h2 class="section-title">المأكولات الإيطالية</h2>
  <div class="menu-container" id="italianDishes"></div>
  <h2 class="section-title">الأكل البيتي</h2>
  <div class="menu-container" id="homeDishes"></div>
  <h2 class="section-title">السلطات</h2>
  <div class="menu-container" id="salads"></div>
  <h2 class="section-title">الساندويتشات</h2>
  <div class="menu-container" id="sandwiches"></div>
  <h2 class="section-title">المعجنات</h2>
  <div class="menu-container" id="pastries"></div>
  <h2 class="section-title">المشروبات</h2>
  <div class="menu-container" id="drinks"></div>
  <h2 class="section-title">الإضافات</h2>
  <div class="menu-container" id="extras"></div>
</div>

<!-- Modal -->
<div class="modal" id="extrasModal">
  <div class="modal-content">
    <h3 id="modalMealName"></h3>
    <div id="extrasContainer" class="extras-grid"></div>
    <div class="modal-buttons">
      <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i> إغلاق</button>
      <button class="add-btn" onclick="confirmAddToCart()"><i class="fas fa-cart-plus"></i> أضف للسلة</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

// استخدم نفس إعدادات Firebase من صفحة التسجيل
const firebaseConfig = {
    apiKey: "AIzaSyC3-Ljb1uKSD4VhgavLUmwebqVivLxFIis",
    authDomain: "cafeteria-app-82268.firebaseapp.com",
    databaseURL: "https://cafeteria-app-82268-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cafeteria-app-82268",
    storageBucket: "cafeteria-app-82268.appspot.com",
    messagingSenderId: "457381739769",
    appId: "1:457381739769:web:409cb927ef54368cb3f628"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

let currentUserUID = null;
let currentUserEmail = null;

// ===== بيانات الوجبات =====
const meals = [
  { name:"شاورما لحم", price:30, img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ30gIEfM4I30W_riIrovoJQLTCDMxK3oXzqQ&s", hasExtras:true, category:"main"},
  { name:"شاورما دجاج", price:25, img:"https://i0.wp.com/www.chefahmed.com/wp-content/uploads/2021/04/Chicken-Shawarma-2.jpg", hasExtras:true, category:"main"},
  { name:"صدر دجاج مشوي", price:28, img:"https://assets.nn.najah.edu/CACHE/images/uploads/weblog/2019/06/06/547597762/573f846611235ba9b74a23760c93ec6d.jpg", hasExtras:true, category:"main"},
  { name:"شنيتسل دجاج", price:22, img:"https://yummy.ps/upload/1561530971-seven-hens-photo-taken-at-chicken-schnitzel-eatery-by-on-3-hensley-hitch-price-(1).jpg", hasExtras:true, category:"main"},
  { name:"كفتة مشوية", price:32, img:"https://www.chefahmed.com/wp-content/uploads/2020/06/kofta-kebab.jpg", hasExtras:true, category:"main"},
];

const sections = {
  main:"mainDishes",
  italian:"italianDishes",
  home:"homeDishes",
  salads:"salads",
  sandwiches:"sandwiches",
  pastries:"pastries",
  drinks:"drinks",
  extras:"extras"
};

// التحقق من حالة المستخدم
onAuthStateChanged(auth, (user) => {
  if (user) {
    // المستخدم مسجل الدخول
    currentUserUID = user.uid;
    currentUserEmail = user.email;
    console.log("المستخدم مسجل دخول:", user.email);
    
    // عرض معلومات المستخدم وزر تسجيل الخروج
    updateUserSection(true, user.email);
    
    // تحميل القائمة بعد التأكد من تسجيل الدخول
    loadMenu();
  } else {
    // المستخدم غير مسجل الدخول
    currentUserUID = null;
    currentUserEmail = null;
    console.log("المستخدم غير مسجل");
    
    // عرض زر تسجيل الدخول
    updateUserSection(false);
    
    // تحميل القائمة
    loadMenu();
  }
});

// تحديث قسم المستخدم في الهيدر
function updateUserSection(isLoggedIn, email = null) {
  const userSection = document.getElementById("userSection");
  
  if (isLoggedIn && email) {
    userSection.innerHTML = `
      <div class="user-info">
        <i class="fas fa-user-circle"></i>
        <span>${email}</span>
      </div>
      <button class="logout-btn" onclick="logoutUser()">
        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
      </button>
    `;
  } else {
    userSection.innerHTML = `
      <a href="index.html" class="login-btn">
        <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
      </a>
    `;
  }
}

// تسجيل الخروج
async function logoutUser() {
  try {
    await signOut(auth);
    alert("✅ تم تسجيل الخروج بنجاح");
    // سيتم تحديث الواجهة تلقائياً عبر onAuthStateChanged
  } catch (error) {
    console.error("خطأ في تسجيل الخروج:", error);
    alert("❌ حدث خطأ أثناء تسجيل الخروج");
  }
}

function loadMenu() {
  meals.forEach(createMealCard);
}

// ===== دوال القائمة =====
function createMealCard(meal) {
  const div = document.createElement("div");
  div.className = "meal-card";
  div.innerHTML = `
    ${meal.hasExtras ? '<span class="badge">+</span>' : ''}
    <img src="${meal.img}" alt="${meal.name}">
    <div class="meal-content">
      <h3>${meal.name}</h3>
      <span class="price">${meal.price} شيكل</span>
      <button onclick="${meal.hasExtras ? `openExtrasModal('${meal.name}', ${meal.price})` : `addToCart('${meal.name}', ${meal.price}, [])`}">
        <i class="fas fa-cart-plus"></i> أضف للسلة
      </button>
    </div>
  `;
  document.getElementById(sections[meal.category]).appendChild(div);
}

// ===== مودال الإضافات =====
let currentMeal = null;
function openExtrasModal(name, price) {
  if(!currentUserUID) { 
    alert("الرجاء تسجيل الدخول أولاً لإضافة منتجات للسلة"); 
    window.location.href = "index.html";
    return; 
  }
  
  currentMeal = { name, price, extras: [] };
  document.getElementById("modalMealName").innerText = name;
  const container = document.getElementById("extrasContainer");
  container.innerHTML = "";
  const extras = ["جبنة إضافية","صوص خاص","خضار إضافية"];
  extras.forEach(extra => {
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" value="${extra}"> ${extra}`;
    container.appendChild(label);
  });
  document.getElementById("extrasModal").style.display = "block";
}

function closeModal() {
  document.getElementById("extrasModal").style.display = "none";
}

function confirmAddToCart() {
  const checkboxes = document.querySelectorAll("#extrasContainer input:checked");
  const extras = Array.from(checkboxes).map(cb => cb.value);
  addToCart(currentMeal.name, currentMeal.price, extras);
  closeModal();
}

async function addToCart(name, price, extras) {
  if(!currentUserUID) { 
    alert("الرجاء تسجيل الدخول أولاً"); 
    window.location.href = "index.html";
    return; 
  }
  
  try {
    const cartRef = ref(database, "carts/" + currentUserUID);
    const newItemRef = push(cartRef);
    await set(newItemRef, { 
      name, 
      price, 
      extras,
      timestamp: Date.now()
    });
    alert("تمت الإضافة إلى السلة ✅");
  } catch (error) {
    console.error("خطأ في إضافة المنتج:", error);
    alert("❌ حدث خطأ أثناء إضافة المنتج للسلة");
  }
}

// ===== فلترة الأقسام =====
const categoryButtons = document.querySelectorAll(".category-btn");
categoryButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    categoryButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const cat = btn.dataset.category;
    filterMealsByCategory(cat);
  });
});

function filterMealsByCategory(category) {
  Object.keys(sections).forEach(sec => {
    document.getElementById(sections[sec]).parentElement.style.display = (category=="all" || category==sec) ? "block" : "none";
  });
}

// جعل الدوال متاحة عالمياً
window.openExtrasModal = openExtrasModal;
window.closeModal = closeModal;
window.confirmAddToCart = confirmAddToCart;
window.addToCart = addToCart;
window.logoutUser = logoutUser;
</script>
</body>
</html>
