<html lang="ar"><head>
  <meta charset="UTF-8">
  <title>Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* (Ù†ÙØ³ Ø§Ù„Ù€ CSS Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø¯ÙŠÙƒØŒ Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡) */
    :root {
      --primary-color: #c62828;
      --primary-light: #ff5f52;
      --primary-dark: #8e0000;
      --secondary-color: #ffb74d;
      --accent-color: #ff9800;
      --light-bg: #fff8f0;
      --card-bg: #ffffff;
      --text-dark: #3e2723;
      --text-light: #5d4037;
      --shadow: 0 4px 12px rgba(198, 40, 40, 0.15);
      --transition: all 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      background-color: var(--light-bg);
      color: var(--text-dark);
      line-height: 1.6;
      padding: 20px;
      text-align: right;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .header h2 { font-size: 1.8rem; margin-bottom: 10px; }
    .header p { opacity: 0.9; }

    .cart-container { max-width: 800px; margin: 0 auto; }

    .empty-cart {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .empty-cart i {
      font-size: 4rem;
      color: var(--primary-light);
      margin-bottom: 20px;
    }

    .empty-cart h3 { color: var(--text-dark); margin-bottom: 10px; }
    .empty-cart p { color: var(--text-light); margin-bottom: 20px; }

    .order-card {
      background-color: var(--card-bg);
      border-radius: 16px;
      margin-bottom: 20px;
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      gap: 15px;
      align-items: center;
      transition: var(--transition);
    }

    .order-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(198, 40, 40, 0.2);
    }

    .order-card img {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .order-details { flex-grow: 1; }
    .order-details h3 { color: var(--text-dark); margin-bottom: 8px; font-size: 1.2rem; }
    .order-details p { color: var(--text-light); margin-bottom: 5px; }

    .price {
      color: var(--primary-color);
      font-weight: bold;
      font-size: 1.1rem;
    }

    .extras { color: var(--text-light); font-size: 0.9rem; margin-top: 5px; }

    .remove-btn {
      background-color: #f8d7da;
      color: #721c24;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }

    .remove-btn:hover { background-color: #f1b0b7; }

    .total-section {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin: 25px 0;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .total-section h3 {
      color: var(--text-dark);
      margin-bottom: 10px;
      font-size: 1.3rem;
    }

    .total-price {
      color: var(--primary-color);
      font-weight: bold;
      font-size: 1.8rem;
      margin: 10px 0;
    }

    .order-form {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }

    .order-form h3 {
      color: var(--primary-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px dashed var(--secondary-color);
      text-align: center;
    }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-dark);
      font-weight: 600;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
    }

    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .payment-method {
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .payment-method:hover { border-color: var(--primary-light); }
    .payment-method.selected {
      border-color: var(--primary-color);
      background-color: rgba(198, 40, 40, 0.05);
    }

    .payment-method i {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: var(--primary-color);
    }

    .payment-method span {
      display: block;
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 25px;
      border: none;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex: 1;
      min-width: 150px;
    }

    .btn-primary {
      background: linear-gradient(to right, var(--primary-color), var(--primary-light));
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(198, 40, 40, 0.2);
    }

    .btn-secondary { background-color: #e9ecef; color: var(--text-dark); }
    .btn-secondary:hover { background-color: #dee2e6; transform: translateY(-3px); }

    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background-color: var(--primary-color);
      color: white;
      transform: translateY(-3px);
    }

    .status-view {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 25px;
      margin: 25px 0;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .status-view h3 { color: var(--primary-color); margin-bottom: 15px; }

    .status-info {
      background-color: #e7f3ff;
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
    }

    .status-info p { margin-bottom: 10px; }

    .my-orders-section { margin-top: 40px; }

    .my-orders-section h3 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px dashed var(--secondary-color);
    }

    .orders-container {
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }

    .order-item-list { margin-top: 15px; padding-right: 15px; }

    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-processing { background-color: #cce7ff; color: #004085; }
    .status-ready { background-color: #d1edff; color: #0c5460; }
    .status-completed { background-color: #d4edda; color: #155724; }

    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-color);
      color: white;
      padding: 15px 25px;
      border-radius: 50px;
      box-shadow: var(--shadow);
      z-index: 10000;
      font-weight: bold;
      animation: fadeInOut 3s ease;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0; transform: translate(-50%, -20px); }
      10%, 90% { opacity: 1; transform: translate(-50%, 0); }
    }

    @media (max-width: 768px) {
      .order-card { flex-direction: column; text-align: center; }
      .action-buttons { flex-direction: column; }
      .btn { width: 100%; }
      .payment-methods { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 480px) {
      .header h2 { font-size: 1.5rem; }
      .payment-methods { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="header">
    <h2><i class="fas fa-shopping-cart"></i> Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <p>Ø±Ø§Ø¬Ø¹ Ø·Ù„Ø¨Ø§ØªÙƒ ÙˆØ£ÙƒÙ…Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡</p>
  </div>

  <div class="cart-container">
    <div id="cartContainer">
      <div class="empty-cart">
        <i class="fas fa-shopping-cart"></i>
        <h3>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</h3>
        <button class="btn btn-primary" onclick="goToMenu()">
          <i class="fas fa-utensils"></i> ØªØµÙØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        </button>
      </div>
    </div>

    <div class="order-form" id="orderSummary" style="display: none;">
      <h3><i class="fas fa-user-edit"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>

      <div class="form-group">
        <label for="studentName"><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ *</label>
        <input type="text" id="studentName" required="" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
        <small style="color: var(--text-light); font-size: 0.8rem;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ ØµØ­ÙŠØ­</small>
      </div>

      <div class="form-group">
        <label for="pickupInput"><i class="fas fa-clock"></i> ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… *</label>
        <input type="time" id="pickupInput" required="">
      </div>

      <div class="form-group">
        <label><i class="fas fa-credit-card"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ *</label>
        <div class="payment-methods">
          <div class="payment-method selected" onclick="selectPaymentMethod(this, 'cash')">
            <i class="fas fa-money-bill-wave"></i>
            <span>Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="noteInput"><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
        <textarea id="noteInput" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="goToMenu()">
          <i class="fas fa-arrow-right"></i> Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        </button>

        <button id="sendOrderBtn" class="btn btn-primary" onclick="startOrderConfirmation()">
          <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        </button>
      </div>
    </div>

    <div id="statusView"></div>

    <div class="my-orders-section">
      <h3><i class="fas fa-clipboard-list"></i> Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
      <div id="myOrdersContainer" class="orders-container"><p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ©.</p></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC3-Ljb1uKSD4VhgavLUmwebqVivLxFIis",
      authDomain: "cafeteria-app-82268.firebaseapp.com",
      databaseURL: "https://cafeteria-app-82268-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cafeteria-app-82268",
      storageBucket: "cafeteria-app-82268.appspot.com",
      messagingSenderId: "457381739769",
      appId: "1:457381739769:web:409cb927ef54368cb3f628"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const cartContainer = document.getElementById("cartContainer");
    const orderSummary = document.getElementById("orderSummary");
    const myOrdersContainer = document.getElementById("myOrdersContainer");

    let order = JSON.parse(localStorage.getItem("order")) || { cart: [] };
    let selectedPaymentMethod = "cash";

    let isSubmittingOrder = false;

    let confirmMode = false;
    let confirmSecondsLeft = 0;
    let confirmIntervalId = null;
    let confirmTimeoutId = null;

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = 'notification';
      if (type === 'error') notification.style.background = 'var(--primary-dark)';
      document.body.appendChild(notification);
      setTimeout(() => { notification.remove(); }, 3000);
    }

    function validateOrderData() {
      const nameValue = document.getElementById("studentName").value.trim();
      const timeValue = document.getElementById("pickupInput").value;

      if (!nameValue || nameValue.length < 2) {
        showNotification("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­", "error");
        return false;
      }
      const arabicRegex = /^[\u0600-\u06FF\s]+$/;
      if (!arabicRegex.test(nameValue)) {
        showNotification("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ ØµØ­ÙŠØ­", "error");
        return false;
      }
      if (!timeValue) {
        showNotification("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…", "error");
        return false;
      }
      return true;
    }

    // âœ… ØªØ·Ø¨ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù†ØµØ±: quantity + unitPrice + lineTotal (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±ÙˆØ¶)
    // - Ù„Ùˆ Ø§Ù„Ø¹Ù†ØµØ± Ø¬Ø§ÙŠ Ù…Ù† Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†ÙŠÙˆ ÙˆÙÙŠÙ‡ totalPrice => Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙƒÙ…Ø¬Ù…ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠ
    // - ØºÙŠØ± Ù‡ÙŠÙƒ => unitPrice * quantity
    function normalizeCartItem(item) {
      const qty = Number(item.quantity ?? item.qty ?? 1) || 1;

      // Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©
      const unitPrice = Number(item.unitPrice ?? item.price ?? 0) || 0;

      // âœ… Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø·Ø±
      let lineTotal = 0;
      if (item.totalPrice != null && !isNaN(Number(item.totalPrice))) {
        lineTotal = Number(item.totalPrice);
      } else {
        lineTotal = unitPrice * qty;
      }

      return {
        ...item,
        quantity: qty,
        unitPrice: unitPrice,
        lineTotal: lineTotal,
      };
    }

    function displayCartItems() {
      cartContainer.innerHTML = "";

      if (order.cart.length > 0) {
        let total = 0;

        order.cart.forEach((rawItem, i) => {
          const item = normalizeCartItem(rawItem);
          total += item.lineTotal;

          const sizeText = item.size ? `Ø§Ù„Ø­Ø¬Ù…: ${item.size}` : "";
          const breadText = item.breadType ? `Ø§Ù„Ø®Ø¨Ø²: ${item.breadType}` : "";
          const optionsLine = (sizeText || breadText)
            ? `<p style="color: var(--text-light); margin-bottom: 5px;"><strong>Ø®ÙŠØ§Ø±Ø§Øª:</strong> ${[sizeText, breadText].filter(Boolean).join(" - ")}</p>`
            : "";

          const div = document.createElement("div");
          div.className = "order-card";
          div.innerHTML = `
            <img src="${item.img}" alt="${item.name}">
            <div class="order-details">
              <h3>${item.name}</h3>
              ${optionsLine}
              <p class="price">
                â‚ª${item.unitPrice} <span style="color: var(--text-light); font-weight: 600;">Ã— ${item.quantity}</span>
                <span style="display:block; margin-top:6px; font-size: 0.95rem;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: â‚ª${item.lineTotal}</span>
              </p>
              ${item.extras?.length ? `<p class="extras"><strong>Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª:</strong> ${item.extras.join(", ")}</p>` : ""}
            </div>
            <button class="remove-btn" onclick="removeItem(${i})">
              <i class="fas fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©
            </button>
          `;
          cartContainer.appendChild(div);
        });

        const totalSection = document.createElement("div");
        totalSection.className = "total-section";
        totalSection.innerHTML = `
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨</h3>
          <div class="total-price">â‚ª${total}</div>
        `;
        cartContainer.appendChild(totalSection);

        orderSummary.style.display = "block";
      } else {
        cartContainer.innerHTML = `
          <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <h3>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</h3>
            <button class="btn btn-primary" onclick="goToMenu()">
              <i class="fas fa-utensils"></i> ØªØµÙØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            </button>
          </div>
        `;
        orderSummary.style.display = "none";
      }
    }

    function removeItem(index) {
      order.cart.splice(index, 1);
      localStorage.setItem("order", JSON.stringify(order));
      displayCartItems();
    }

    function selectPaymentMethod(element, method) {
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method').forEach(btn => btn.classList.remove('selected'));
      element.classList.add('selected');
    }

    function goToMenu() {
      window.location.href = "menu.html";
    }

    function clearCartPageAfterSend() {
      order = { cart: [] };
      localStorage.removeItem("order");
      displayCartItems();

      document.getElementById("noteInput").value = "";
      document.getElementById("pickupInput").value = "";

      cancelOrderConfirmation(true);
    }

    function setSendButtonText(text, disabled = false) {
      const btn = document.getElementById("sendOrderBtn");
      if (!btn) return;
      btn.innerHTML = text;
      btn.disabled = !!disabled;
      btn.style.opacity = disabled ? "0.7" : "1";
      btn.style.cursor = disabled ? "not-allowed" : "pointer";
    }

    function cancelOrderConfirmation(silent = false) {
      confirmMode = false;
      confirmSecondsLeft = 0;

      if (confirmIntervalId) clearInterval(confirmIntervalId);
      if (confirmTimeoutId) clearTimeout(confirmTimeoutId);
      confirmIntervalId = null;
      confirmTimeoutId = null;

      setSendButtonText('<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', false);
      if (!silent) showNotification("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯", "error");
    }

    function startOrderConfirmation() {
      if (isSubmittingOrder || localStorage.getItem("orderSubmitting") === "1") {
        showNotification("â›” Ø§Ù„Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„... Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹", "error");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        showNotification('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!', 'error');
        setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        return;
      }

      if (!validateOrderData()) return;

      if (!order.cart || order.cart.length === 0) {
        showNotification("âš ï¸ Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙØ§Ø±ØºØ©", "error");
        return;
      }

      if (confirmMode) {
        submitOrder();
        return;
      }

      confirmMode = true;
      confirmSecondsLeft = 10;

      showNotification("ğŸ•’ Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ø§Ù†ØªØ¸Ø± 10 Ø«ÙˆØ§Ù†ÙŠ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§", "success");
      setSendButtonText(`<i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (${confirmSecondsLeft})`, false);

      confirmIntervalId = setInterval(() => {
        confirmSecondsLeft--;
        if (confirmSecondsLeft <= 0) {
          clearInterval(confirmIntervalId);
          confirmIntervalId = null;
        } else {
          setSendButtonText(`<i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (${confirmSecondsLeft})`, false);
        }
      }, 1000);

      confirmTimeoutId = setTimeout(() => {
        submitOrder();
      }, 10000);
    }

    async function submitOrder() {
      if (isSubmittingOrder || localStorage.getItem("orderSubmitting") === "1") {
        showNotification("â›” Ø§Ù„Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„... Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹", "error");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        showNotification('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!', 'error');
        setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        return;
      }

      if (!validateOrderData()) return;

      if (!order.cart || order.cart.length === 0) {
        showNotification("âš ï¸ Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙØ§Ø±ØºØ©", "error");
        return;
      }

      isSubmittingOrder = true;
      localStorage.setItem("orderSubmitting", "1");

      if (confirmIntervalId) clearInterval(confirmIntervalId);
      if (confirmTimeoutId) clearTimeout(confirmTimeoutId);
      confirmIntervalId = null;
      confirmTimeoutId = null;
      confirmMode = false;

      setSendButtonText('<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...', true);

      const timeValue = document.getElementById("pickupInput").value;
      const nameValue = document.getElementById("studentName").value.trim();
      const note = document.getElementById("noteInput").value.trim();
      const orderCode = Math.floor(100000 + Math.random() * 900000);

      const normalizedItems = order.cart.map(normalizeCartItem);

      const newOrder = {
        code: orderCode,
        studentName: nameValue,
        userId: user.uid,
        items: normalizedItems.map(it => ({
          name: it.name,
          img: it.img,
          quantity: it.quantity,
          unitPrice: it.unitPrice,
          lineTotal: it.lineTotal,
          extras: it.extras || [],
          size: it.size || "",
          breadType: it.breadType || ""
        })),
        pickupTime: timeValue,
        paymentMethod: selectedPaymentMethod,
        notes: note,
        total: normalizedItems.reduce((sum, it) => sum + it.lineTotal, 0),
        status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
        timestamp: new Date().toISOString()
      };

      try {
        const now = Date.now();
        const last = Number(localStorage.getItem("lastOrderSentAt") || 0);
        if (now - last < 20000) {
          throw new Error("TOO_FAST");
        }

        await db.ref("orders").push(newOrder);
        localStorage.setItem("lastOrderSentAt", String(now));

        clearCartPageAfterSend();

        showStatusTracking(newOrder);
        showNotification("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", "success");

        showMyOrders();
      } catch (error) {
        if (String(error.message || "").includes("TOO_FAST")) {
          showNotification("â›” Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ÙŠÙ† Ø¨Ø³Ø±Ø¹Ø©. Ø§Ù†ØªØ¸Ø± 20 Ø«Ø§Ù†ÙŠØ©", "error");
        } else {
          showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨", "error");
          console.error("Error writing to database:", error);
        }
      } finally {
        isSubmittingOrder = false;
        localStorage.removeItem("orderSubmitting");
        setSendButtonText('<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', false);
      }
    }

    function showStatusTracking(data) {
      const statusView = document.getElementById("statusView");
      statusView.innerHTML = `
        <div class="status-view">
          <h3><i class="fas fa-check-circle"></i> ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ</h3>
          <div class="status-info">
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${data.code}</p>
            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span class="order-status status-pending">${data.status}</span></p>
          </div>
        </div>
      `;
    }

    function showMyOrders() {
      myOrdersContainer.innerHTML = "<p>ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...</p>";
      const user = auth.currentUser;

      if (!user) {
        myOrdersContainer.innerHTML = "<p>âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¤ÙŠØ© Ø·Ù„Ø¨Ø§ØªÙƒ.</p>";
        return;
      }

      db.ref("orders").orderByChild("userId").equalTo(user.uid).on("value", snapshot => {
        myOrdersContainer.innerHTML = "";

        if (!snapshot.exists()) {
          myOrdersContainer.innerHTML = "<p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ©.</p>";
          return;
        }

        snapshot.forEach(child => {
          const ord = child.val();
          const card = document.createElement("div");
          card.className = "order-card";

          let statusClass = "status-pending";
          if (ord.status === "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±") statusClass = "status-processing";
          else if (ord.status === "Ø¬Ø§Ù‡Ø²") statusClass = "status-ready";
          else if (ord.status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") statusClass = "status-completed";

          card.innerHTML = `
            <div style="width: 100%;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>ğŸ§¾ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${ord.code}</h3>
                <span class="order-status ${statusClass}">${ord.status}</span>
              </div>
              <p><strong>â° ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</strong> ${ord.pickupTime}</p>
            </div>
          `;
          myOrdersContainer.appendChild(card);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      displayCartItems();

      auth.onAuthStateChanged(user => {
        if (user) {
          showMyOrders();
          db.ref('users/' + user.uid).once('value').then(snapshot => {
            if (snapshot.exists() && snapshot.val().username) {
              document.getElementById('studentName').value = snapshot.val().username;
            }
          });
        } else {
          showMyOrders();
        }
      });
    });

    window.addEventListener("beforeunload", () => {
      if (confirmIntervalId) clearInterval(confirmIntervalId);
      if (confirmTimeoutId) clearTimeout(confirmTimeoutId);
    });
  </script>

</body></html>
