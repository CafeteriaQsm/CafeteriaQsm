<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>سلة الطلبات</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #c62828;
            --primary-light: #ff5f52;
            --primary-dark: #8e0000;
            --secondary-color: #ffb74d;
            --accent-color: #ff9800;
            --light-bg: #fff8f0;
            --card-bg: #ffffff;
            --text-dark: #3e2723;
            --text-light: #5d4037;
            --shadow: 0 4px 12px rgba(198, 40, 40, 0.15);
            --transition: all 0.3s ease;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; text-align: right; background-color: var(--light-bg); color: var(--text-dark); }

        .header { padding: 20px; text-align: center; background-color: var(--primary-color); color: white; }
        .cart-container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .order-card { display: flex; align-items: center; justify-content: space-between; background-color: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .order-card img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .order-details { flex: 1; margin-right: 15px; }
        .order-details h3 { margin-bottom: 5px; }
        .price { font-weight: bold; color: var(--primary-color); }
        .remove-btn { background-color: #eee; border: none; padding: 8px 12px; border-radius: 50px; cursor: pointer; transition: var(--transition); }
        .remove-btn:hover { background-color: #ddd; }
        .total-section { padding: 15px; background-color: #f5f5f5; border-radius: 12px; text-align: center; margin-top: 20px; }
        .order-form { background-color: #fff; padding: 20px; border-radius: 12px; margin-top: 20px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
        .payment-methods { display: flex; gap: 10px; margin-top: 5px; }
        .payment-method { flex: 1; padding: 10px; text-align: center; border: 2px solid var(--primary-color); border-radius: 50px; cursor: pointer; transition: var(--transition); }
        .payment-method.selected { background-color: var(--primary-color); color: white; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border-radius: 50px; cursor: pointer; border: none; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 8px; transition: var(--transition); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: #eee; }
        .btn-secondary:hover { background-color: #ddd; }
        .my-orders-section { margin-top: 30px; }
        .orders-container { margin-top: 15px; }
        .status-info { padding: 15px; background-color: #fff; border-radius: 12px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .order-status.pending { color: orange; font-weight: bold; }
        .order-status.confirmed { color: green; font-weight: bold; }
        .order-status.rejected { color: red; font-weight: bold; }
        .order-item-list { list-style: none; padding: 0; margin-top: 10px; }
        .order-item-list li { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .order-item-list img { width: 40px; height: 40px; object-fit: cover; border-radius: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h2><i class="fas fa-shopping-cart"></i> سلة الطلبات</h2>
    <p>راجع طلباتك وأكمل عملية الشراء</p>
</div>

<div class="cart-container">
    <div id="cartContainer"></div>

    <div class="order-form" id="orderSummary" style="display:none;">
        <h3><i class="fas fa-user-edit"></i> معلومات الطلب</h3>
        <div class="form-group">
            <label for="studentName"><i class="fas fa-user"></i> اسم الطالب</label>
            <input type="text" id="studentName" placeholder="أدخل اسمك الكامل">
        </div>
        <div class="form-group">
            <label for="pickupInput"><i class="fas fa-clock"></i> وقت الاستلام</label>
            <input type="time" id="pickupInput">
        </div>
        <div class="form-group">
            <label><i class="fas fa-credit-card"></i> طريقة الدفع</label>
            <div class="payment-methods">
                <div class="payment-method" onclick="selectPaymentMethod(event,'cash')"><i class="fas fa-money-bill-wave"></i> نقداً</div>
                <div class="payment-method" onclick="selectPaymentMethod(event,'card')"><i class="fas fa-credit-card"></i> بطاقة</div>
                <div class="payment-method" onclick="selectPaymentMethod(event,'mobile')"><i class="fas fa-mobile-alt"></i> محفظة</div>
            </div>
        </div>
        <div class="form-group">
            <label for="noteInput"><i class="fas fa-sticky-note"></i> ملاحظات إضافية</label>
            <textarea id="noteInput" rows="3" placeholder="اختياري"></textarea>
        </div>
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="goToMenu()"><i class="fas fa-arrow-right"></i> الرجوع للقائمة</button>
            <button class="btn btn-primary" onclick="confirmOrder()"><i class="fas fa-paper-plane"></i> إرسال الطلب</button>
        </div>
    </div>

    <div class="my-orders-section">
        <h3><i class="fas fa-clipboard-list"></i> طلباتي الحالية</h3>
        <button class="btn btn-secondary" onclick="showMyOrders()"><i class="fas fa-eye"></i> عرض طلباتي</button>
        <div id="myOrdersContainer" class="orders-container"></div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyCu4ged4p8GzaQo4DFbY_sthYWHSvSYqpU",
    authDomain: "cafeteria-students-app.firebaseapp.com",
    databaseURL: "https://cafeteria-students-app-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cafeteria-students-app",
    storageBucket: "cafeteria-students-app.appspot.com",
    messagingSenderId: "338557210649",
    appId: "1:338557210649:web:ba36c4623b4677ca585a88"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUserId = null;

// إزالة إعادة التوجيه - المستخدم يمكنه البقاء في الصفحة حتى بدون تسجيل دخول
firebase.auth().onAuthStateChanged(user => {
    if(user) {
        currentUserId = user.uid;
        initCart(user.uid);
    } else {
        currentUserId = null;
        // بدلاً من إعادة التوجيه، نعرض رسالة للمستخدم
        initCart(null);
    }
});

function initCart(userId){
    const cartContainer = document.getElementById("cartContainer");
    const orderSummary = document.getElementById("orderSummary");
    const myOrdersContainer = document.getElementById("myOrdersContainer");
    const order = JSON.parse(localStorage.getItem("order")) || { cart: [] };
    let selectedPaymentMethod = "cash";

    if(order.cart.length>0){
        let total=0;
        order.cart.forEach((item,i)=>{
            total += item.price;
            const div = document.createElement("div");
            div.className="order-card";
            div.innerHTML = `
                <img src="${item.img}" alt="${item.name}">
                <div class="order-details">
                    <h3>${item.name}</h3>
                    <p class="price">₪${item.price}</p>
                    ${item.extras?.length ? `<p class="extras"><strong>الإضافات:</strong> ${item.extras.join(", ")}</p>` : ""}
                </div>
                <button class="remove-btn" onclick="removeItem(${i})"><i class="fas fa-trash"></i> إزالة</button>
            `;
            cartContainer.appendChild(div);
        });
        const totalSection = document.createElement("div");
        totalSection.className="total-section";
        totalSection.innerHTML=`<h3>إجمالي الطلب</h3><div class="total-price">₪${total}</div>`;
        cartContainer.appendChild(totalSection);
        orderSummary.style.display="block";
    } else {
        cartContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-shopping-cart" style="font-size: 4rem; color: var(--primary-light); margin-bottom: 20px;"></i>
                <h3>السلة فارغة</h3>
                <p>لم تقم بإضافة أي عناصر إلى سلة التسوق بعد</p>
                <button class="btn btn-primary" onclick="goToMenu()" style="margin-top: 20px;">
                    <i class="fas fa-utensils"></i> تصفح القائمة
                </button>
            </div>
        `;
    }

    window.removeItem = function(index){
        order.cart.splice(index,1);
        localStorage.setItem("order",JSON.stringify(order));
        location.reload();
    }

    window.selectPaymentMethod = function(event,method){
        selectedPaymentMethod=method;
        document.querySelectorAll(".payment-method").forEach(btn=>btn.classList.remove("selected"));
        event.currentTarget.classList.add("selected");
    }

    window.goToMenu = function(){ 
        window.location.href="menu.html"; 
    }

    window.confirmOrder = function(){
        // التحقق من تسجيل الدخول قبل إرسال الطلب
        if(!currentUserId) {
            alert("⚠️ الرجاء تسجيل الدخول أولاً لإرسال الطلب");
            window.location.href = "index.html";
            return;
        }

        const nameValue = document.getElementById("studentName").value.trim();
        const timeValue = document.getElementById("pickupInput").value;
        const noteValue = document.getElementById("noteInput").value.trim();
        
        if(!nameValue || !timeValue){ 
            alert("⚠️ الرجاء تعبئة جميع الحقول المطلوبة"); 
            return; 
        }

        const newOrder = {
            userId: currentUserId,
            name: nameValue,
            time: timeValue,
            note: noteValue,
            payment: selectedPaymentMethod,
            cart: order.cart,
            status: "pending",
            timestamp: Date.now()
        };

        // إرسال الطلب إلى قاعدة البيانات - مربوط مع صفحة الأدمن
        db.ref("orders").push(newOrder)
            .then(()=>{ 
                alert("✅ تم إرسال الطلب بنجاح!"); 
                localStorage.removeItem("order"); 
                location.reload(); 
            })
            .catch(err=>{ 
                console.error(err); 
                alert("❌ حدث خطأ أثناء إرسال الطلب: "+err.message); 
            });
    }

    window.showMyOrders = function(){
        // التحقق من تسجيل الدخول قبل عرض الطلبات
        if(!currentUserId) {
            alert("⚠️ الرجاء تسجيل الدخول أولاً لعرض طلباتك");
            window.location.href = "index.html";
            return;
        }

        myOrdersContainer.innerHTML="";
        const ordersRef = db.ref("orders").orderByChild("userId").equalTo(currentUserId);
        ordersRef.on("value", snapshot=>{
            myOrdersContainer.innerHTML="";
            const data = snapshot.val();
            if(data){
                Object.entries(data).forEach(([key, orderItem])=>{
                    const div = document.createElement("div");
                    div.className="status-info";
                    div.innerHTML = `
                        <p><strong>الاسم:</strong> ${orderItem.name}</p>
                        <p><strong>وقت الاستلام:</strong> ${orderItem.time}</p>
                        <p><strong>طريقة الدفع:</strong> ${orderItem.payment}</p>
                        <p><strong>حالة الطلب:</strong> <span class="order-status ${orderItem.status}">${orderItem.status}</span></p>
                        <ul class="order-item-list">
                            ${orderItem.cart.map(ci=>`<li><img src="${ci.img}" alt="${ci.name}"/><span>${ci.name} - ₪${ci.price}</span></li>`).join("")}
                        </ul>
                    `;
                    myOrdersContainer.appendChild(div);
                });
            } else { 
                myOrdersContainer.innerHTML="<p style='text-align: center; padding: 20px;'>لا توجد طلبات حالية.</p>"; 
            }
        });
    }
}
</script>
</body>
</html>
